444 CONSTANT S-PORT

REQUIRE NEW-LOC lib\sserver.4 
REQUIRE COM_INIT COM.4 

100 CONSTANT  X-BUFF-SIZE

CREATE TCP-BUFF  X-BUFF-SIZE ALLOT
CREATE SCI-BUFF  X-BUFF-SIZE ALLOT


: TCP-DO
\ ." TCP-DO <"
	TCP-BUFF
	DUP X-BUFF-SIZE ACC-LOC SRead DUP 0<
	IF \	." >;"
		2DROP   ACC-LOC CloseSocket DROP
		-1 TO ACC-LOC EXIT 
	THEN
\ 2DUP TYPE ." >"
\	1 PAUSE
	TO_COM_
;

: SCI-DO
        SCI-BUFF DUP X-BUFF-SIZE COMPORT_ID READ-FILE DROP
\ ." SCI-DO <" 2DUP TYPE ." >"
\	1 PAUSE
	ACC-LOC SWrite DROP
;

: TCP<>SCI
  BEGIN
	NEW-LOC	

	ACC-LOC -1 <>
	IF
		COM-CNT
		IF	SCI-DO
		ELSE
		   ACC-LOC ToRead \ n fkg
			IF  CR ." DISCONNECT"   ACC-LOC CloseSocket DROP
				-1 TO ACC-LOC EXIT 
			THEN
			IF  TCP-DO
			ELSE \ KEY? IF KEY 0x20 OR [CHAR] q = IF EXIT THEN THEN
			THEN 
		THEN
	THEN
  AGAIN
;

\ EOF

COM_INIT  TCP<>SCI
